# CrewHub Code Audit ‚Äî 2026-02-20

**Project:** `/Users/ekinbot/ekinapps/crewhub/`  
**Version:** v0.17.x  
**Scope:** Frontend (TypeScript/TSX) ¬∑ Backend (Python/FastAPI) ¬∑ Architecture  
**Analyst:** ekinbot (automated sub-agent audit)

---

## 1. File Size Table ‚Äî Top 20 Largest Files

> Thresholds: ‚ö†Ô∏è Warning >300 ¬∑ üî¥ Critical >500 ¬∑ üö® Extreme >800 lines

### Frontend (TypeScript / TSX)

| # | File | Lines | Risk | Notes |
|---|------|-------|------|-------|
| 1 | `components/sessions/SettingsPanel.tsx` | **2608** | üö® Extreme | God component: wraps ALL settings tabs (Look&Feel, Sessions, Connections, Agents, Personas, Identity, Projects, Backup, Dev/Config, Rooms, Rules). Contains 8+ sub-components inline. |
| 2 | `lib/mockApi.ts` | **2018** | üö® Extreme | Entire mock backend in one file: fake fetch, EventSource, data stubs for 15+ resources. |
| 3 | `components/world3d/zones/creator/FullscreenPropMaker.tsx` | **1952** | üö® Extreme | Full 3D prop creation UI + streaming AI + code editor + part list in one component. |
| 4 | `components/world3d/World3DView.tsx` | **1623** | üö® Extreme | The entire 3D world viewport, camera, rooms, bots, interactions, modals all in one file. |
| 5 | `components/onboarding/OnboardingWizard.tsx` | **1132** | üö® Extreme | Multi-step wizard with all steps inlined; logic + UI mixed. |
| 6 | `components/mobile/MobileCreatorView.tsx` | **1011** | üö® Extreme | Mobile-specific full prop creator, mirrors much of FullscreenPropMaker. |
| 7 | `App.tsx` | **884** | üö® Extreme | Root component ‚Äî contains 7 top-level functions (`AppContent`, `ZenWorkspaceSelector`, `ZenModeAppContent`, `ZenModeApp`, etc.), inline routing logic, and multiple state machines. |
| 8 | `components/world3d/grid/GridRoomRenderer.tsx` | **884** | üö® Extreme | Grid tile rendering with per-cell logic, prop placement, animations ‚Äî all inline. |
| 9 | `components/world3d/Bot3D.tsx` | **880** | üö® Extreme | Single 3D bot: model loading, animations, pathfinding, pixel-art fallback ‚Äî too broad. |
| 10 | `components/sessions/AgentsSettingsTab.tsx` | **832** | üö® Extreme | Agent registry CRUD + sort + config; could split into AgentList, AgentForm, AgentDetail. |
| 11 | `components/zen/ZenMode.tsx` | **841** | üö® Extreme | Orchestrator for all Zen panels; contains `renderPanel()` switch with 20+ cases. |
| 12 | `components/world3d/AgentTopBar.tsx` | **850** | üö® Extreme | Manages top-bar including model picker, session picker, room picker, project picker. |
| 13 | `components/world3d/ProjectDocsPanel.tsx` | **798** | üö® Extreme | Full document browser + markdown viewer embedded in the 3D world sidebar. |
| 14 | `components/onboarding/OpenClawWizard.tsx` | **768** | üö® Extreme | Second wizard type (OpenClaw-specific), overlaps with OnboardingWizard in structure. |
| 15 | `components/sessions/ConnectionsView.tsx` | **761** | üö® Extreme | Connections CRUD list + test dialog + health check ‚Äî one component. |
| 16 | `components/zen/hooks/useZenMode.tsx` | **667** | üî¥ Critical | Context + state + persistence + migration + UUID ‚Äî too many responsibilities for a hook file. |
| 17 | `components/zen/FullscreenDetailView.tsx` | **714** | üî¥ Critical | Detail view for both Activity and Session panels ‚Äî two panels sharing one 700-line file. |
| 18 | `components/zen/ZenChatPanel.tsx` | **629** | üî¥ Critical | Chat UI, agent picker, voice recorder, streaming, file drop ‚Äî should be split. |
| 19 | `components/zen/ProjectManagerModal.tsx` | **521** | üî¥ Critical | Modal + list + CRUD + file path config for projects ‚Äî too wide for a modal. |
| 20 | `components/zen/ZenLayoutManager.tsx` | **507** | üî¥ Critical | Save modal + layout picker + layout presets + recent layouts in one file. |

### Backend (Python)

| # | File | Lines | Risk | Notes |
|---|------|-------|------|-------|
| 1 | `routes/creator.py` | **1524** | üö® Extreme | AI prop generation: streaming, template, history, saved props, showcase, refine, iterate ‚Äî 15 endpoints in one file. |
| 2 | `services/connections/openclaw.py` | **1049** | üö® Extreme | WebSocket connection handling + history fetch + streaming + device identity in one class. |
| 3 | `db/database.py` | **1021** | üö® Extreme | Schema definition (all 20+ tables), migrations, seeding, health check ‚Äî monolithic. |
| 4 | `services/meeting_orchestrator.py` | **991** | üö® Extreme | State machine, AI turn logic, synthesis, recovery ‚Äî should be split into state/AI/storage layers. |
| 5 | `routes/blueprints.py` | **786** | üö® Extreme | Room blueprint CRUD + validation + import/export + showcase in 786 lines. |
| 6 | `routes/connections.py` | **646** | üî¥ Critical | Connection CRUD + health + device status + connect/disconnect + streaming test. |
| 7 | `routes/threads.py` | **610** | üî¥ Critical | Group-chat thread management + messages + SSE streaming in one route file. |
| 8 | `routes/tasks.py` | **598** | üî¥ Critical | Task CRUD + history events + display names + run trigger ‚Äî inline helper functions mixed with routes. |
| 9 | `routes/projects.py` | **509** | üî¥ Critical | Project CRUD + folder path management + room assignment + security sandbox. |
| 10 | `routes/personas.py` | **496** | ‚ö†Ô∏è Warning | Persona CRUD + system persona logic + identity management. Uses raw `aiosqlite.connect` instead of `get_db()`. |

---

## 2. Code Duplication Findings

### 2.1 PRIORITY_CONFIG ‚Äî Defined 3√ó (Critical)

**Files:**
- `frontend/src/components/zen/ZenTasksPanel.tsx` ‚Äî lines 28‚Äì33
- `frontend/src/components/zen/ZenKanbanPanel.tsx` ‚Äî lines 35‚Äì41
- `frontend/src/components/mobile/MobileKanbanPanel.tsx` ‚Äî lines 32‚Äì38

All three define the same `PRIORITY_CONFIG: Record<TaskPriority, { label, color, weight }>` object with identical keys (`urgent`, `high`, `medium`, `low`) and near-identical values. The mobile version uses hardcoded hex `'#ef4444'` instead of `'var(--zen-error)'`, creating a subtle theme inconsistency.

**Additionally**, `TaskForm.tsx` has its own `priorityOptions` array with the same data as a flat array.

**Fix:** Extract to `frontend/src/hooks/useTasks.ts` or a new `frontend/src/lib/taskConstants.ts`.

---

### 2.2 COLUMNS / STATUS_CONFIG ‚Äî Defined 2‚Äì3√ó

**Files:**
- `frontend/src/components/zen/ZenTasksPanel.tsx` ‚Äî `STATUS_CONFIG` + `COLUMNS` at lines 20‚Äì41
- `frontend/src/components/zen/ZenKanbanPanel.tsx` ‚Äî `COLUMNS` at lines 27‚Äì33

Both define the same 5-status columns (`todo`, `in_progress`, `review`, `blocked`, `done`) with identical icons and ordering. A shared `taskConfig.ts` would eliminate this.

---

### 2.3 `formatTimestamp` / `formatDuration` / `formatTokens` ‚Äî Defined 2‚Äì3√ó

**Files:**
- `frontend/src/components/zen/FullscreenDetailView.tsx` ‚Äî lines 36‚Äì73
- `frontend/src/components/zen/ZenActivityDetailPanel.tsx` ‚Äî lines 34‚Äì70

Both files define `formatTimestamp(ts)`, `formatDuration(start, end?)`, `formatTokens(n?)`, and `formatMessageTime(ts?)` with near-identical implementations. `ZenActivityDetailPanel` imports `FullscreenDetailView` but doesn't reuse its format helpers.

`formatTokens` appears a **third time** in `PixelAvatar/PixelAvatar.tsx` (line 51) with slightly different formatting logic (K suffix vs plain number).

**Fix:** Centralize in `frontend/src/lib/formatters.ts`.

---

### 2.4 `formatDate` / `formatTime` ‚Äî Inline in Multiple Files

**Files:**
- `frontend/src/components/zen/ZenLogsPanel.tsx` ‚Äî `formatTime()` at line 32
- `frontend/src/components/zen/ZenStatusBar.tsx` ‚Äî `formatTime()` at line 18
- `frontend/src/components/zen/ZenErrorBoundary.tsx` ‚Äî `formatTime()` at line 211
- `frontend/src/components/zen/ZenDocsPanel.tsx` ‚Äî `formatDate()` at line 24
- `frontend/src/components/zen/ZenActivityDetailPanel.tsx` ‚Äî `formatTimestamp()` at line 34
- `frontend/src/components/standups/StandupHistory.tsx` ‚Äî inline `formatDate` at line 47
- `frontend/src/components/sessions/SettingsPanel.tsx` ‚Äî two different `formatDate` functions at lines 1723 and 2165

At least **7 separate inline date/time formatters** exist across the codebase. Each has slightly different locale options, making the UX inconsistent (some use `en-US`, some `en-GB`, some `nl-BE`).

---

### 2.5 DB Connection Pattern ‚Äî `get_db()` + `try/finally/close` Repeated 80√ó (Critical)

**Pattern repeated in:** `tasks.py`, `projects.py`, `rooms.py`, `blueprints.py`, `display_names.py`, `standups.py`, `agents.py`, etc.

Every route follows this pattern:
```python
db = await get_db()
try:
    db.row_factory = lambda cursor, row: dict(zip([col[0] for col in cursor.description], row))
    # ... query logic ...
finally:
    await db.close()
```

This is found **80+ times** across routes. Additionally, `get_db()` itself is not a context manager ‚Äî it returns a raw connection, requiring manual `finally: await db.close()` everywhere.

**Variants also exist:** Some routes (`personas.py` lines 102‚Äì443, `meetings.py` lines 207‚Äì272, `backup.py` lines 126‚Äì221) bypass `get_db()` entirely and call `aiosqlite.connect(DB_PATH)` directly as a context manager ‚Äî the correct pattern that others don't follow.

**Fix:** Convert `get_db()` to an async context manager, or create a `get_db_conn()` that uses `async with`. The `row_factory` line should also be set at the context manager level.

---

### 2.6 `db.row_factory` Assignment ‚Äî 80 Occurrences

Related to 2.5: the `db.row_factory = lambda cursor, row: dict(...)` line appears **80 times** across route files. Some use the zip format, others use `aiosqlite.Row`. There is no consistent pattern.

---

### 2.7 `ZenEmptyPanel` Pattern ‚Äî Duplicated Inline

The `.zen-empty-icon` / `.zen-empty-title` / `.zen-empty-subtitle` empty-state HTML structure is manually repeated in:
- `ZenChatPanel.tsx` (lines 32‚Äì38 and 162‚Äì186) ‚Äî 2 inline empty states  
- `ZenActivityPanel.tsx` (lines 131‚Äì133)  
- `ZenCronPanel.tsx` (lines 149‚Äì151)

Despite `ZenEmptyPanel.tsx` existing as a dedicated component (77 lines), most panels implement their own empty states inline instead of reusing it.

---

### 2.8 `ActivityEvent` Interface ‚Äî Defined 2√ó

**Files:**
- `frontend/src/components/zen/FullscreenDetailView.tsx` ‚Äî lines 15‚Äì23
- `frontend/src/components/zen/ZenActivityDetailPanel.tsx` ‚Äî lines 14‚Äì22

Identical interface defined in both files. Since `ZenActivityDetailPanel` already imports `FullscreenDetailView`, this is redundant.

---

### 2.9 Backend: Repeated Error Wrapping Pattern

**Pattern (49 occurrences across routes):**
```python
except Exception as e:
    logger.error(f"Failed to ...: {e}")
    raise HTTPException(status_code=500, detail=str(e))
```

This is present **49 times** in routes. A reusable `@handle_db_errors` decorator or FastAPI exception handler would eliminate this noise.

---

### 2.10 `MobileCreatorView` vs `FullscreenPropMaker` ‚Äî Near-Duplicate

`MobileCreatorView.tsx` (1011 lines) is a mobile adaptation of `FullscreenPropMaker.tsx` (1952 lines). Both implement:
- AI prop generation with streaming
- Props list management
- Part config display
- Generation history

Significant business logic is duplicated. A shared `usePropGeneration` hook could extract the streaming/state logic, leaving only layout differences in each component.

---

## 3. Architecture & Structure Review

### 3.1 Overall Folder Structure ‚Äî ‚úÖ Mostly Good

```
frontend/src/
  App.tsx                  ‚Üê Root (too large)
  components/              ‚Üê UI components
    zen/                   ‚Üê Zen Mode panels (well-organized)
    sessions/              ‚Üê Session management
    world3d/               ‚Üê 3D workspace
    mobile/                ‚Üê Mobile layout
    tasks/                 ‚Üê Task board
    chat/                  ‚Üê Chat windows
    onboarding/            ‚Üê Onboarding flows
    ui/                    ‚Üê shadcn primitives
  contexts/                ‚Üê React contexts (9 total)
  hooks/                   ‚Üê Custom hooks (31 total)
  lib/                     ‚Üê API client, utilities, SSE
  utils/                   ‚Üê Only mediaParser.ts (underpopulated)
```

The folder structure is logical and navigation is mostly clear. The `zen/` folder is well-organized with `hooks/`, `themes/`, `registry/`, `types/`, and `utils/` subdirectories ‚Äî a pattern worth extending.

**Issues:**
- `utils/` contains only one file (`mediaParser.ts`) ‚Äî all the inline format helpers from Section 2 should live here.
- `lib/` mixes API clients, state (meetingStore, devErrorStore), utilities, and mock data at the same level.
- `App.tsx` functions as both entry point and a container for 5 large app-level components ‚Äî should be split.

---

### 3.2 Hooks vs Components Separation ‚Äî ‚ö†Ô∏è Mixed

**Good:** `hooks/useTasks.ts`, `hooks/useProjects.ts`, `hooks/useRooms.ts`, `hooks/useAgentFiles.ts` are clean data-fetching hooks with no UI code. `useRooms` is properly a thin wrapper around `RoomsContext`.

**Issues:**
- `hooks/useZenMode.tsx` (667 lines, note `.tsx` extension) combines Context provider, state management, localStorage persistence, UUID generation, and layout migration. This is a context module, not just a hook.
- `hooks/useMeeting.ts` (443 lines) contains state machine logic that belongs in a service layer.
- Several hooks (`useStreamingChat`, `useAgentChat`) do heavy API call logic that would be better in a service layer.

---

### 3.3 God Components ‚Äî üî¥ Present

**`SettingsPanel.tsx` (2608 lines)** is the primary God Component. It imports and renders 7+ tabs (Look&Feel, Sessions, Agents, Personas, Identity, Projects, Connections, Backup, Dev/Config) with tab-specific state, forms, and API calls all in one file. Sub-components `ProjectsSettingsSection`, `BackupSection`, `ThresholdsTimingSection` are defined inline at the bottom rather than as separate files.

**`ZenMode.tsx` (841 lines)** `renderPanel()` function is a 200-line switch statement that dispatches to all panel types. This is fine architecturally, but it means ZenMode imports every panel type, creating a fat import chain.

**`World3DView.tsx` (1623 lines)** is a God Component for the 3D world: manages rooms, bots, cameras, context menus, prop placement, and overlays in one file.

---

### 3.4 Backend: Routes vs Services vs DB ‚Äî ‚ö†Ô∏è Blurry Boundary

**Routes** are supposed to handle HTTP; **services** business logic; **DB** data access. In practice:

- Routes (`tasks.py`, `projects.py`, `rooms.py`) contain direct `db.execute()` calls with raw SQL ‚Äî there is **no service layer** for these resources.
- Only the more complex features (meetings, connections, history, context) have proper services in `app/services/`.
- The `creator.py` route (1524 lines) contains generation logic (`_stream_prop_generation`, `_parse_ai_parts`, `_detect_shape`), storage logic (`_load_generation_history`, `_save_props_to_disk`), and route handlers all in one file. This should be split into a `services/creator.py` and `services/prop_generation.py`.

---

### 3.5 Database Layer ‚Äî ‚ö†Ô∏è Connection Leak Risk

`get_db()` returns a raw `aiosqlite.Connection` without a context manager interface. Callers must manually call `await db.close()` in a `finally` block. **Missing a `finally` block leaks the connection.** There are currently 80+ call sites ‚Äî and not all of them properly close the connection (particularly in nested `try` blocks in `projects.py`).

Some routes use `async with aiosqlite.connect(DB_PATH)` directly (the correct pattern) while others use `get_db()` (risky pattern). This inconsistency will cause subtle bugs under load.

**`database.py` (1021 lines)** also contains all 20+ table `CREATE TABLE IF NOT EXISTS` statements, all migrations inline, seed data, and health check ‚Äî it serves as schema manager + migration runner + DB factory in one file.

---

### 3.6 Prop Drilling ‚Äî ‚ö†Ô∏è Present but Contained

Project filter state is prop-drilled through `ZenMode` ‚Üí `ZenTasksPanel` / `ZenKanbanPanel` via `projectId`, `roomId`, `roomFocusName`, `onProjectFilterChange`. Since these are panel-level props, it's acceptable for now, but a `ZenProjectFilterContext` would be cleaner.

Session/agent selection is also drilled from `ZenMode` into `ZenChatPanel` (7 props). This is at the boundary of acceptable complexity.

---

### 3.7 Theme System ‚Äî ‚úÖ Well Designed

The theme system is notably well-designed (documented in `THEME_SYSTEM.md`):
- Single source of truth in `zen/themes/*.ts`
- CSS variable bridging to both Tailwind (`--background`, `--primary`) and Zen vars (`--zen-bg`, `--zen-fg`)
- `ThemeContext` applies to `:root` for global coverage
- Theme cycling keyboard shortcut works everywhere

**One issue:** 154 inline `style={{ color: 'var(--zen-fg-muted)' }}` usages in zen components are repetitive. Theme-aware utility classes (e.g., `.zen-text-muted`) would reduce noise.

---

### 3.8 Circular Dependencies ‚Äî None Detected

No obvious circular imports were found. The `zen/registry/PanelRegistry.ts` and `zen/index.ts` barrel exports appear well-ordered. The backend's `routes/sse.py` is imported by nearly every route (`from .sse import broadcast`) which is acceptable for an SSE broadcast bus.

---

### 3.9 Context Proliferation ‚Äî ‚ö†Ô∏è 9 Contexts

The app uses 9 React contexts: `Theme`, `Chat`, `Rooms`, `Demo`, `Zone`, `DragDrop`, `TaskBoard`, `WorldFocus`, `Meeting`. Each is provided at the App root, meaning all updates flow to all consumers. The `RoomsContext` (which does live polling) is particularly broad.

**Good:** `RoomsContext` was deliberately centralized to prevent duplicate API calls (noted in `useRooms.ts`). This was the right call.

**Issue:** `TaskBoardContext` and `DragDropContext` are likely only used in the 3D world and task board views ‚Äî wrapping the entire app in them is wasteful.

---

## 4. Priority Recommendations

### ü•á P1 ‚Äî Fix Database Connection Leak (v0.18.0)

**Impact:** Correctness, stability, production-readiness  
**Effort:** Medium

Convert `get_db()` to an async context manager:
```python
@asynccontextmanager
async def get_db():
    db = await aiosqlite.connect(DB_PATH)
    db.row_factory = lambda cursor, row: dict(zip([col[0] for col in cursor.description], row))
    try:
        yield db
    finally:
        await db.close()
```

Update all 80+ call sites to use `async with get_db() as db:`. This eliminates connection leaks and the repetitive `row_factory` pattern simultaneously. The `personas.py` and `meetings.py` files that already use `async with aiosqlite.connect()` confirm this pattern works.

---

### ü•à P2 ‚Äî Split `SettingsPanel.tsx` (v0.18.0)

**Impact:** Maintainability, bundle splitting, developer experience  
**Effort:** Medium

Extract each tab into its own component file:
```
components/settings/
  SettingsPanel.tsx        ‚Üê Just the tabs shell (< 100 lines)
  SettingsLookAndFeel.tsx
  SettingsAgents.tsx       ‚Üê Already exists as AgentsSettingsTab.tsx ‚úÖ
  SettingsPersonas.tsx
  SettingsProjects.tsx     ‚Üê Already: ProjectsSettingsSection (can extract)
  SettingsBackup.tsx       ‚Üê Already: BackupSection (can extract)
  SettingsConnections.tsx  ‚Üê Already: ConnectionsView.tsx ‚úÖ
  SettingsDevConfig.tsx
```

This will make the settings area testable, navigable, and lazy-loadable.

---

### ü•â P3 ‚Äî Extract Shared Task Constants (v0.18.0)

**Impact:** Consistency, DRY, theme safety  
**Effort:** Low

Create `frontend/src/lib/taskConstants.ts`:
```typescript
export const PRIORITY_CONFIG: Record<TaskPriority, { label: string; color: string; weight: number }> = {
  urgent: { label: 'URG', color: 'var(--zen-error)', weight: 0 },
  high:   { label: 'HI',  color: 'var(--zen-warning)', weight: 1 },
  medium: { label: 'MED', color: 'var(--zen-info)', weight: 2 },
  low:    { label: 'LO',  color: 'var(--zen-fg-muted)', weight: 3 },
}

export const STATUS_CONFIG: Record<TaskStatus, { icon: string; label: string; color: string }> = { ... }

export const TASK_COLUMNS: ColumnConfig[] = [ ... ]
```

Remove the 3 duplicate `PRIORITY_CONFIG` definitions from `ZenTasksPanel`, `ZenKanbanPanel`, and `MobileKanbanPanel`. This also ensures MobileKanbanPanel uses theme vars instead of hardcoded `#ef4444`.

---

### üèÖ P4 ‚Äî Extract Format Helpers (v0.18.0)

**Impact:** Consistency, reusability  
**Effort:** Low

Create `frontend/src/utils/formatters.ts`:
```typescript
export function formatTimestamp(ts: number): string { ... }
export function formatDuration(startTs: number, endTs?: number): string { ... }
export function formatTokens(n?: number): string { ... }
export function formatRelativeTime(ts: number): string { ... }
```

Remove the 7 inline date/time formatters across zen components and use one standard implementation with consistent locales.

---

### üèÖ P5 ‚Äî Split `creator.py` Route into Service Layer (v0.18.0)

**Impact:** Backend maintainability, testability  
**Effort:** High

Split the 1524-line `creator.py` into:
```
backend/app/
  routes/creator.py         ‚Üê Route handlers only (~200 lines)
  services/prop_generator.py ‚Üê AI streaming, template generation, parsing
  services/prop_storage.py   ‚Üê CRUD for saved props and history (file-based JSON)
  services/prop_showcase.py  ‚Üê Showcase discovery logic
```

The `_stream_prop_generation` async generator (lines 527‚Äì934) alone is 400+ lines and has no business being in a route file.

---

## 5. Summary

| Category | Status | Details |
|----------|--------|---------|
| File sizes | üî¥ Critical | 15+ files over 800 lines; SettingsPanel at 2608 is the worst |
| Code duplication | üî¥ Critical | PRIORITY_CONFIG √ó3, formatTimestamp √ó3, DB pattern √ó80 |
| Architecture (frontend) | ‚ö†Ô∏è Warning | Good hook/context split; God components in settings and 3D |
| Architecture (backend) | ‚ö†Ô∏è Warning | No service layer for CRUD resources; routes do DB work directly |
| DB connection safety | üî¥ Critical | `get_db()` leaks without `finally`; inconsistent patterns |
| Theme system | ‚úÖ Good | Well-designed, documented, single source of truth |
| Folder structure | ‚úÖ Good | Logical, navigable, zen/ is a good model to follow |
| Circular deps | ‚úÖ None | No circular imports detected |
| Context proliferation | ‚ö†Ô∏è Warning | 9 app-wide contexts; some could be scoped lower |

---

*Generated by ekinbot code audit ‚Äî 2026-02-20*
